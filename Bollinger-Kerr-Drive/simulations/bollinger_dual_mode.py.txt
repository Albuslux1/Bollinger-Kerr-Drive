import numpy as np
import matplotlib.pyplot as plt

# Bollinger Cloud Evolution with Hawking + Planck fluctuations
# Dual-mode: stellar engine vs primordial firecracker

# Configuration
use_hawking = True                     # True = primordial, False = stellar  
M_initial = 5e-8 if use_hawking else 1.0  # geometric units (primordial ≈ 5e-8 g)
mode_name = "PRIMORDIAL FIRECRACKER" if use_hawking else "STELLAR ENGINE"

# Physical parameters
a = 0.998
m = 1
r_plus = M_initial + np.sqrt(M_initial**2 - a**2)
Omega_H = a / (2 * M_initial * r_plus)

# Growth and damping rates (scale with mass)
gamma_lin = 1.3e-6 * (1.0 / M_initial)  # Linear superradiant growth
damping_coeff = 1.8e-11 * (1.0 / M_initial**2)  # Nonlinear saturation

# Hawking evaporation (primordial only)
hawking_coeff = 1.0 / (M_initial**3) if use_hawking else 0.0

# Planck fluctuation coupling (quantum gravity effects)
M_planck = 2.176e-8  # Planck mass in kg (geometric units ~1 in Planck units)
planck_coupling = (M_planck / M_initial)**2 if M_initial > 0 else 0

# Time parameters
if use_hawking:
    t_max = 1.0  # seconds for primordial (fast evolution)
    points = 50000  # High resolution for burst
else:
    t_max = 2.5e6  # M for stellar (slow evolution)  
    points = 10000

t = np.linspace(0, t_max, points)
dt = t[1] - t[0]

# Initialize arrays
Gamma = np.ones_like(t)
planck_amplification = np.zeros_like(t)
hawking_evaporation = np.zeros_like(t)

print(f"Running {mode_name} simulation...")
print(f"M = {M_initial:.2e} | a = {a} | Hawking = {use_hawking}")

for i in range(1, len(t)):
    # Linear superradiant growth
    dG = gamma_lin * Gamma[i-1] * dt
    
    # Nonlinear saturation (cubic damping)
    dG -= damping_coeff * Gamma[i-1]**3 * dt
    
    # Hawking evaporation (primordial only)
    if use_hawking:
        hawking_loss = hawking_coeff * Gamma[i-1] * dt
        dG -= hawking_loss
        hawking_evaporation[i] = hawking_loss
    
    # Planck fluctuation coupling near burst threshold
    if Gamma[i-1] > 100 and use_hawking:
        # Quantum fluctuations amplified by high curvature
        fluctuation = planck_coupling * Gamma[i-1]**3 * np.random.normal(0, 0.1) * dt
        dG += fluctuation
        planck_amplification[i] = fluctuation
    
    Gamma[i] = Gamma[i-1] + dG
    
    # Minimum bound (vacuum state)
    if Gamma[i] < 1.0:
        Gamma[i] = 1.0
    
    # Break if black hole evaporates completely
    if use_hawking and Gamma[i] <= 1.01 and i > 1000:
        Gamma[i:] = 1.0
        break

# Analysis
peak_Gamma = np.max(Gamma)
peak_time = t[np.argmax(Gamma)]
ctc_threshold = 1.02  # Minimum for CTC formation
ctc_indices = Gamma > ctc_threshold
ctc_duration = t[ctc_indices][-1] - t[ctc_indices][0] if np.any(ctc_indices) else 0

print(f"\n--- RESULTS ---")
print(f"Peak frame-dragging: Γ = {peak_Gamma:.1f}")
print(f"Time to peak: {peak_time:.2e} s")
print(f"CTC window duration: {ctc_duration:.2e} s")
print(f"Final state: Γ = {Gamma[-1]:.2f}")

# Plotting
plt.figure(figsize=(12, 8))

# Main evolution plot
plt.subplot(2, 1, 1)
plt.plot(t, Gamma, 'teal', lw=2.2, label='Frame-dragging amplification Γ(t)')
plt.axhspan(1.02, 1.18, alpha=0.15, color='orange', label='CTC threshold window')
plt.axhline(peak_Gamma, color='crimson', ls='--', alpha=0.7, 
           label=f'Peak Γ = {peak_Gamma:.1f}')

if use_hawking:
    plt.axvspan(t[ctc_indices][0] if np.any(ctc_indices) else 0, 
                t[ctc_indices][-1] if np.any(ctc_indices) else 0, 
                alpha=0.2, color='purple', label=f'CTC window: {ctc_duration:.1e} s')

plt.ylim(0.8, max(120, peak_Gamma * 1.1))
plt.ylabel('Frame-dragging amplification Γ(t)')
plt.title(f'Bollinger Cloud Evolution — {mode_name}\n'
          f'M = {M_initial:.2e} | Peak Γ = {peak_Gamma:.1f} | '
          f'CTC duration = {ctc_duration:.1e} s', fontsize=14)
plt.legend()
plt.grid(alpha=0.3)

# Effects breakdown
plt.subplot(2, 1, 2)
effects = [hawking_evaporation, planck_amplification]
labels = ['Hawking Evaporation', 'Planck Fluctuations']
colors = ['red', 'blue']

for effect, label, color in zip(effects, labels, colors):
    if np.max(np.abs(effect)) > 0:
        plt.plot(t, effect, color=color, label=label, alpha=0.7)

plt.xlabel('Time [s]' if use_hawking else 'Time [M]')
plt.ylabel('Effect Strength')
plt.title('Quantum Effects Breakdown')
plt.legend()
plt.grid(alpha=0.3)

plt.tight_layout()
plt.savefig(f'bollinger_evolution_{"primordial" if use_hawking else "stellar"}.png', 
           dpi=350, bbox_inches='tight')
plt.show()

# Burst analysis for primordial mode
if use_hawking and ctc_duration > 0:
    burst_start = t[ctc_indices][0]
    burst_peak = t[np.argmax(Gamma)]
    print(f"\n--- BURST ANALYSIS ---")
    print(f"CTC activation: {burst_start:.2e} s")
    print(f"Burst peak: {burst_peak:.2e} s") 
    print(f"Rise time: {burst_peak - burst_start:.2e} s")
    print(f"Planck fluctuations during burst: {np.max(np.abs(planck_amplification)):.2e}")